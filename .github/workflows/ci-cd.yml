name: FastAPIâ€Š/â€ŠCelery CI-CD

on:
  push:
    branches: [ "main" ]          # main ë¸Œëœì¹˜ push ì‹œë§Œ íŠ¸ë¦¬ê±°

permissions:
  contents: read

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) ì´ë¯¸ì§€ ë¹Œë“œ + í‘¸ì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  build-push-image:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # - name: ğŸ› ï¸ Build & Push Image
      #   run: |
      #     IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/closhare_inference:latest
      #     docker build -t $IMAGE .
      #     docker push $IMAGE

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) EC2ì—ì„œ êµì²´ ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-on-ec2:
    needs: build-push-image
    runs-on: self-hosted            # EC2 ëŸ¬ë„ˆ

    steps:
      # 1) ìµœì‹  ì´ë¯¸ì§€ ë‹¹ê²¨ì˜¤ê¸°
      - name: ğŸ“¥ Docker Pull
        run: sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/closhare_inference:latest

      # 2) compose ìŠ¤íƒ êµì²´
      - name: ğŸš€ Deploy with docker-compose
        run: |
          cd /home/ec2-user/closhare          # compose.yml ì´ ìˆëŠ” í´ë”ë¡œ ìˆ˜ì •
          docker compose down --remove-orphans || true
          docker compose pull                 # ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½ ì‹œ ê°±ì‹ 
          docker compose up -d

      # 3) ëˆ„ìˆ˜ ì´ë¯¸ì§€ ì •ë¦¬
      - name: ğŸ§¹ Image GC
        run: docker image prune -f
