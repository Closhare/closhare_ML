name: FastAPI / Celery CI-CD

on:
  push:
    branches: [ "main" ]          # main 브랜치 push 시만 트리거

permissions:
  contents: read

# ────────────────────── 1) 이미지 빌드 + 푸시 ──────────────────────
jobs:
  build-push-image:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔑 Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # - name: 🛠️ Build & Push Image
      #   run: |
      #     IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/closhare_inference:latest
      #     docker build -t $IMAGE .
      #     docker push $IMAGE

# ────────────────────── 2) EC2에서 교체 실행 ──────────────────────
  deploy-on-ec2:
    needs: build-push-image
    runs-on: self-hosted            # EC2 러너

    steps:
      # 1) 최신 이미지 당겨오기
      - name: 📥 Docker Pull
        run: sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/closhare_inference:latest

      # 2) compose 스택 교체
      - name: 🚀 Deploy with docker-compose
        run: |
          cd /home/ec2-user/closhare          # compose.yml 이 있는 폴더로 수정
          docker compose down --remove-orphans || true
          docker compose pull                 # 이미지 태그 변경 시 갱신
          docker compose up -d

      # 3) 누수 이미지 정리
      - name: 🧹 Image GC
        run: docker image prune -f
